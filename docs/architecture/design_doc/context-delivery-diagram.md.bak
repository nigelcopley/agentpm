# Context Delivery System - Visual Reference

## System Architecture

```mermaid
graph TD
    A[Agent Request] --> B[ContextAssemblyService]
    B --> C[Entity Loading]
    B --> D[6W Merging]
    B --> E[Plugin Facts]
    B --> F[Amalgamations]
    B --> G[Confidence Scoring]
    B --> H[Agent SOP]
    B --> I[Temporal Context]
    B --> J[Role Filtering]

    C --> K[Database]
    D --> K
    E --> L[Plugin System]
    F --> M[.agentpm/contexts/]
    H --> N[.claude/agents/]
    I --> K

    K --> O[ContextPayload]
    L --> O
    M --> O
    N --> O
    G --> O
    J --> O

    O --> P[Agent Execution]
```

## Hierarchical Context Flow

```mermaid
graph LR
    A[Project Context] --> D[Merged Context]
    B[Work Item Context] --> D
    C[Task Context] --> D

    D --> E[Plugin Facts]
    D --> F[Amalgamations]
    D --> G[Agent SOP]

    E --> H[ContextPayload]
    F --> H
    G --> H

    H --> I[Agent]
```

## Stage-Specific Context

```mermaid
graph TD
    A[D1: Discovery] --> B[Idea Context]
    B --> C[Business Pillars]
    B --> D[Market Research]

    E[P1: Planning] --> F[Work Item Context]
    F --> G[Technical Context]
    F --> H[Quality Gates]

    I[I1: Implementation] --> J[Task Context]
    J --> K[Code Amalgamations]
    J --> L[Agent SOP]

    M[R1: Review] --> N[Test Results]
    N --> O[Coverage Reports]

    P[O1/E1: Operations] --> Q[Deployment Context]
    Q --> R[Monitoring Data]
```

## Performance Breakdown

```
Assembly Time: 120ms (target: <200ms)

Entity Loading     â–“â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  10ms (8%)
6W Merging        â–“â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘   5ms (4%)
Plugin Facts      â–“â–“â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  20ms (17%) [cached]
                  â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“ 100ms (83%) [fresh]
Amalgamations     â–“â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  10ms (8%)
Confidence        â–“â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  10ms (8%)
Agent SOP         â–“â–“â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  15ms (13%)
Temporal          â–“â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  10ms (8%)
Role Filtering    â–“â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘   5ms (4%)
Overhead          â–“â–“â–“â–‘â–‘â–‘â–‘â–‘â–‘â–‘  35ms (29%)
```

## Confidence Calculation

```
Total Confidence = 0.85

  6W Completeness (30%)     â–“â–“â–“â–“â–“â–“â–“â–“â–“â–‘  0.90
  Plugin Facts (25%)        â–“â–“â–“â–“â–“â–“â–“â–“â–‘â–‘  0.80
  Amalgamations (25%)       â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“  1.00
  Freshness (20%)           â–“â–“â–“â–“â–“â–“â–“â–‘â–‘â–‘  0.70

  Confidence Band: GREEN (>0.8)
```

## Entity Hierarchy

```
Project (ID: 1)
â”œâ”€â”€ Tech Stack: Python, FastAPI, PostgreSQL
â”œâ”€â”€ Team: @engineering, @design
â””â”€â”€ Standards: PEP 8, Type hints required

  Work Item (ID: 45): "User Authentication"
  â”œâ”€â”€ Type: FEATURE
  â”œâ”€â”€ Business Value: "Secure user access"
  â”œâ”€â”€ Dependencies: [OAuth2 integration]
  â””â”€â”€ AC: ["SSO support", "RBAC", "Audit logs"]

    Task (ID: 355): "Implement JWT tokens"
    â”œâ”€â”€ Type: IMPLEMENTATION
    â”œâ”€â”€ Assigned: python-implementer
    â”œâ”€â”€ Effort: 3.5h
    â””â”€â”€ AC: ["Tokens expire 1h", "Refresh supported"]
```

## Role-Based Filtering

```
Original Context (unfiltered):
â”œâ”€â”€ Amalgamations (15 files)
â”‚   â”œâ”€â”€ Python: classes, functions, imports
â”‚   â”œâ”€â”€ React: components, hooks, routes
â”‚   â””â”€â”€ Testing: fixtures, conftest
â””â”€â”€ Plugin Facts (8 frameworks)
    â”œâ”€â”€ Python: FastAPI, Pydantic, SQLAlchemy
    â””â”€â”€ React: Zustand, React Router, Tailwind

Filtered for "python-implementer":
â”œâ”€â”€ Amalgamations (7 files) â† 53% reduction
â”‚   â”œâ”€â”€ Python: classes, functions, imports
â”‚   â””â”€â”€ Testing: pytest fixtures (Python-relevant)
â””â”€â”€ Plugin Facts (4 frameworks) â† 50% reduction
    â””â”€â”€ Python: FastAPI, Pydantic, SQLAlchemy
```

## Context Lifecycle

```mermaid
stateDiagram-v2
    [*] --> Draft: Create Context
    Draft --> Populated: Add 6W Data
    Populated --> Fresh: Validate
    Fresh --> Stale: 30 days pass
    Stale --> Fresh: Refresh
    Fresh --> Updated: Code Changes
    Updated --> Fresh: Validate
    Fresh --> [*]: Task Complete
```

## Multi-Agent Context Sharing

```
Work Item: "API Development"
â”œâ”€â”€ Task 1: Backend (python-implementer)
â”‚   â””â”€â”€ Context: Python facts + backend amalgamations
â”œâ”€â”€ Task 2: Frontend (react-developer)
â”‚   â””â”€â”€ Context: React facts + frontend amalgamations
â””â”€â”€ Task 3: Testing (testing-specialist)
    â””â”€â”€ Context: pytest facts + test amalgamations

All share: Work Item 6W, Project standards
Each has: Role-specific filtered context
```

## Quick Reference: Context Commands

```bash
# View context
apm context show --task-id=355 --format=json

# Validate quality
apm context validate --task-id=355

# Refresh (update timestamp, re-detect)
apm context refresh --task-id=355

# Update 6W
apm context update --task-id=355 \
  --who="@alice,@bob" \
  --what="Implement JWT" \
  --acceptance-criteria="Tokens expire 1h"
```

## Performance Targets

| Metric | Target | Current | Status |
|--------|--------|---------|--------|
| Assembly p95 | <200ms | 180ms | âœ… GREEN |
| Assembly avg | <120ms | 120ms | âœ… GREEN |
| Confidence | >0.70 | 0.85 | âœ… GREEN |
| Cache hit rate | >70% | N/A | ðŸŸ¡ Phase 2 |
| Context freshness | <30 days | 21 days | âœ… GREEN |

## Integration Example

```python
# Standard pattern (all agents use this)
from agentpm.core.context.assembly_service import ContextAssemblyService

# 1. Initialize service
service = ContextAssemblyService(db, project_path)

# 2. Assemble context
payload = service.assemble_task_context(
    task_id=355,
    agent_role="python-implementer"
)

# 3. Access hierarchical data
project = payload.project['name']
work_item = payload.work_item['type']
task = payload.task['status']

# 4. Access merged 6W
who = payload.merged_6w.implementers
what = payload.merged_6w.acceptance_criteria
why = payload.merged_6w.business_value

# 5. Access plugin intelligence
tech_stack = payload.plugin_facts
code_files = payload.amalgamations

# 6. Check quality
if payload.confidence_band == ConfidenceBand.RED:
    print("Warning: Low context quality")

# 7. Use temporal context
recent_sessions = payload.temporal_context
```

---

**Document**: Visual Reference for Unified Context Delivery System
**Companion to**: UNIFIED-CONTEXT-DELIVERY-SYSTEM.md
**Last Updated**: 2025-10-17
