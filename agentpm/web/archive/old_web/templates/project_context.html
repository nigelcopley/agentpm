{% extends "layouts/modern_base.html" %}

{% block title %}{{ view.project.name }} - Context - APM (Agent Project Manager){% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="/projects/{{ view.project.id }}">{{ view.project.name }}</a></li>
        <li class="breadcrumb-item active" aria-current="page">Project Context</li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="row mb-4 animate-slide-in">
    <div class="col">
        <div class="card metric-card shadow-soft">
            <div class="card-body">
                <h2 class="card-title">
                    <i class="bi bi-diagram-3 text-gradient"></i> Project Context
                </h2>
                <p class="lead">{{ view.project.name }}</p>
                <p class="text-muted mb-0">
                    6W Framework Intelligence: <strong>WHO • WHAT • WHERE • WHEN • WHY • HOW</strong>
                </p>

                {% if view.has_context %}
                <!-- Context Metadata -->
                <div class="row mt-3">
                    <div class="col-md-4">
                        <small class="text-muted">
                            Confidence Score:
                            {% if view.confidence_score %}
                                <span class="badge badge-{% if view.confidence_score >= 0.7 %}success{% elif view.confidence_score >= 0.4 %}warning{% else %}danger{% endif %}">
                                    {{ (view.confidence_score * 100) | round(1) }}%
                                </span>
                            {% else %}
                                <span class="badge badge-gray">N/A</span>
                            {% endif %}
                        </small>
                    </div>
                    <div class="col-md-4">
                        <small class="text-muted">
                            Confidence Band:
                            {% if view.confidence_band %}
                                <span class="badge badge-{% if view.confidence_band == 'GREEN' %}success{% elif view.confidence_band == 'YELLOW' %}warning{% else %}danger{% endif %}">
                                    {{ view.confidence_band }}
                                </span>
                            {% else %}
                                <span class="badge badge-gray">N/A</span>
                            {% endif %}
                        </small>
                    </div>
                    <div class="col-md-4">
                        <small class="text-muted">
                            Freshness:
                            {% if view.freshness_days is not none %}
                                <span class="badge badge-{% if view.freshness_days <= 7 %}success{% elif view.freshness_days <= 30 %}warning{% else %}danger{% endif %}">
                                    {{ view.freshness_days }} days old
                                </span>
                            {% else %}
                                <span class="badge badge-gray">Just created</span>
                            {% endif %}
                        </small>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% if view.has_context %}
<!-- 6W Framework Display -->
<div class="row mb-4">
    <!-- WHO Card -->
    <div class="col-md-6 mb-3">
        <div class="card metric-card shadow-soft h-100">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-people"></i> WHO - Team & Stakeholders</h5>
            </div>
            <div class="card-body">
                {% if view.context.who %}
                    <p class="mb-0">{{ view.context.who }}</p>
                {% else %}
                    <p class="text-muted mb-0">Not specified</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- WHAT Card -->
    <div class="col-md-6 mb-3">
        <div class="card metric-card shadow-soft h-100">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="bi bi-list-task"></i> WHAT - Requirements</h5>
            </div>
            <div class="card-body">
                {% if view.context.what %}
                    <p class="mb-0">{{ view.context.what }}</p>
                {% else %}
                    <p class="text-muted mb-0">Not specified</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- WHERE Card -->
    <div class="col-md-6 mb-3">
        <div class="card metric-card shadow-soft h-100">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="bi bi-geo-alt"></i> WHERE - Technical Context</h5>
            </div>
            <div class="card-body">
                {% if view.context.where %}
                    <p class="mb-0">{{ view.context.where }}</p>
                {% else %}
                    <p class="text-muted mb-0">Not specified</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- WHEN Card -->
    <div class="col-md-6 mb-3">
        <div class="card metric-card shadow-soft h-100">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0"><i class="bi bi-calendar-event"></i> WHEN - Timeline</h5>
            </div>
            <div class="card-body">
                {% if view.context.when_context %}
                    <p class="mb-0">{{ view.context.when_context }}</p>
                {% else %}
                    <p class="text-muted mb-0">Not specified</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- WHY Card -->
    <div class="col-md-6 mb-3">
        <div class="card metric-card shadow-soft h-100">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0"><i class="bi bi-bullseye"></i> WHY - Value Proposition</h5>
            </div>
            <div class="card-body">
                {% if view.context.why %}
                    <p class="mb-0">{{ view.context.why }}</p>
                {% else %}
                    <p class="text-muted mb-0">Not specified</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- HOW Card -->
    <div class="col-md-6 mb-3">
        <div class="card metric-card shadow-soft h-100">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0"><i class="bi bi-tools"></i> HOW - Approach</h5>
            </div>
            <div class="card-body">
                {% if view.context.how %}
                    <p class="mb-0">{{ view.context.how }}</p>
                {% else %}
                    <p class="text-muted mb-0">Not specified</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Context Details (Optional - can expand for more detail) -->
{% if view.context.six_w %}
<div class="row mb-4">
    <div class="col">
        <div class="card metric-card shadow-soft">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> Detailed Context Structure</h5>
            </div>
            <div class="card-body">
                <div class="accordion" id="contextAccordion">
                    <!-- WHO Details -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#whoDetails">
                                <i class="bi bi-people me-2"></i> WHO - Detailed Roles
                            </button>
                        </h2>
                        <div id="whoDetails" class="accordion-collapse collapse" data-bs-parent="#contextAccordion">
                            <div class="accordion-body">
                                {% if view.context.six_w.implementers %}
                                    <strong>Implementers:</strong>
                                    <ul>
                                        {% for impl in view.context.six_w.implementers %}
                                        <li>{{ impl }}</li>
                                        {% endfor %}
                                    </ul>
                                {% endif %}
                                {% if view.context.six_w.reviewers %}
                                    <strong>Reviewers:</strong>
                                    <ul>
                                        {% for reviewer in view.context.six_w.reviewers %}
                                        <li>{{ reviewer }}</li>
                                        {% endfor %}
                                    </ul>
                                {% endif %}
                                {% if view.context.six_w.end_users %}
                                    <strong>End Users:</strong>
                                    <ul>
                                        {% for user in view.context.six_w.end_users %}
                                        <li>{{ user }}</li>
                                        {% endfor %}
                                    </ul>
                                {% endif %}
                                {% if not view.context.six_w.implementers and not view.context.six_w.reviewers and not view.context.six_w.end_users %}
                                    <p class="text-muted mb-0">No detailed role information available</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- WHAT Details -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#whatDetails">
                                <i class="bi bi-list-task me-2"></i> WHAT - Detailed Requirements
                            </button>
                        </h2>
                        <div id="whatDetails" class="accordion-collapse collapse" data-bs-parent="#contextAccordion">
                            <div class="accordion-body">
                                {% if view.context.six_w.functional_requirements %}
                                    <strong>Functional Requirements:</strong>
                                    <ul>
                                        {% for req in view.context.six_w.functional_requirements %}
                                        <li>{{ req }}</li>
                                        {% endfor %}
                                    </ul>
                                {% endif %}
                                {% if view.context.six_w.technical_constraints %}
                                    <strong>Technical Constraints:</strong>
                                    <ul>
                                        {% for constraint in view.context.six_w.technical_constraints %}
                                        <li>{{ constraint }}</li>
                                        {% endfor %}
                                    </ul>
                                {% endif %}
                                {% if view.context.six_w.acceptance_criteria %}
                                    <strong>Acceptance Criteria:</strong>
                                    <ul>
                                        {% for criteria in view.context.six_w.acceptance_criteria %}
                                        <li>{{ criteria }}</li>
                                        {% endfor %}
                                    </ul>
                                {% endif %}
                                {% if not view.context.six_w.functional_requirements and not view.context.six_w.technical_constraints and not view.context.six_w.acceptance_criteria %}
                                    <p class="text-muted mb-0">No detailed requirement information available</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- WHERE Details -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#whereDetails">
                                <i class="bi bi-geo-alt me-2"></i> WHERE - Technical Environment
                            </button>
                        </h2>
                        <div id="whereDetails" class="accordion-collapse collapse" data-bs-parent="#contextAccordion">
                            <div class="accordion-body">
                                {% if view.context.six_w.affected_services %}
                                    <strong>Affected Services:</strong>
                                    <ul>
                                        {% for service in view.context.six_w.affected_services %}
                                        <li>{{ service }}</li>
                                        {% endfor %}
                                    </ul>
                                {% endif %}
                                {% if view.context.six_w.repositories %}
                                    <strong>Repositories:</strong>
                                    <ul>
                                        {% for repo in view.context.six_w.repositories %}
                                        <li>{{ repo }}</li>
                                        {% endfor %}
                                    </ul>
                                {% endif %}
                                {% if view.context.six_w.deployment_targets %}
                                    <strong>Deployment Targets:</strong>
                                    <ul>
                                        {% for target in view.context.six_w.deployment_targets %}
                                        <li>{{ target }}</li>
                                        {% endfor %}
                                    </ul>
                                {% endif %}
                                {% if not view.context.six_w.affected_services and not view.context.six_w.repositories and not view.context.six_w.deployment_targets %}
                                    <p class="text-muted mb-0">No detailed environment information available</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- HOW Details -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#howDetails">
                                <i class="bi bi-tools me-2"></i> HOW - Approach & Patterns
                            </button>
                        </h2>
                        <div id="howDetails" class="accordion-collapse collapse" data-bs-parent="#contextAccordion">
                            <div class="accordion-body">
                                {% if view.context.six_w.suggested_approach %}
                                    <strong>Suggested Approach:</strong>
                                    <p>{{ view.context.six_w.suggested_approach }}</p>
                                {% endif %}
                                {% if view.context.six_w.existing_patterns %}
                                    <strong>Existing Patterns:</strong>
                                    <ul>
                                        {% for pattern in view.context.six_w.existing_patterns %}
                                        <li>{{ pattern }}</li>
                                        {% endfor %}
                                    </ul>
                                {% endif %}
                                {% if not view.context.six_w.suggested_approach and not view.context.six_w.existing_patterns %}
                                    <p class="text-muted mb-0">No detailed approach information available</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% else %}
<!-- No Context Message -->
<div class="row mb-4">
    <div class="col">
        <div class="alert alert-info" role="alert">
            <h5 class="alert-heading">
                <i class="bi bi-info-circle"></i> Context Not Generated Yet
            </h5>
            <p>
                AIPM automatically generates project context based on code analysis, work items, and tasks.
                The 6W framework (WHO/WHAT/WHERE/WHEN/WHY/HOW) provides comprehensive project intelligence
                that helps AI agents understand your project at every level.
            </p>
            <hr>
            <p class="mb-0">
                <strong>Context will appear here once:</strong>
            </p>
            <ul class="mb-0">
                <li>The system processes your project structure</li>
                <li>Work items and tasks are created</li>
                <li>Code analysis plugins extract framework intelligence</li>
            </ul>
        </div>
    </div>
</div>
{% endif %}

<!-- Context Files Card -->
<div class="card mt-4 shadow-soft">
    <div class="card-body text-center">
        <i class="bi bi-folder2-open text-primary" style="font-size: 2rem;"></i>
        <h5 class="mt-3">Generated Context Files</h5>
        <p class="text-muted">Browse and download framework-generated context amalgamations</p>
        <a href="/context-files" class="btn btn-primary">
            <i class="bi bi-files"></i> Browse Context Files
        </a>
    </div>
</div>

<!-- Back to Project Button -->
<div class="row mt-4">
    <div class="col">
        <a href="/projects/{{ view.project.id }}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Back to Project
        </a>
    </div>
</div>
{% endblock %}
