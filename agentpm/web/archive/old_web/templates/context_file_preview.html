{% extends "layouts/modern_base.html" %}

{% block title %}{{ view.filename }} â€¢ Context Preview{% endblock %}

{% block content %}
<section class="mb-8 flex flex-wrap items-start justify-between gap-3">
  <div>
    <h1 class="text-3xl font-semibold text-gray-900">{{ view.filename }}</h1>
    <p class="mt-2 text-sm text-gray-500">Preview generated context content and download the raw file.</p>
    <p class="mt-1 font-mono text-xs text-gray-400"><i class="bi bi-folder me-2"></i>{{ view.filepath }}</p>
  </div>
  <a href="/context-files" class="inline-flex items-center gap-2 rounded-lg border border-gray-200 bg-white px-4 py-2 text-sm font-medium text-gray-600 shadow-sm transition hover:border-primary/30 hover:text-primary">
    <i class="bi bi-arrow-left"></i>
    Back to Context Files
  </a>
</section>

<section class="grid gap-4 md:grid-cols-3">
  <article class="rounded-2xl border border-gray-200 bg-white p-5 shadow-sm">
    <p class="text-xs font-semibold uppercase tracking-wide text-gray-500">File Size</p>
    <p class="mt-2 text-2xl font-semibold text-gray-900">{{ (view.size_bytes / 1024) | round(2) }} KB</p>
    <p class="text-xs text-gray-500">{{ "{:,}".format(view.size_bytes) }} bytes</p>
  </article>
  <article class="rounded-2xl border border-gray-200 bg-white p-5 shadow-sm">
    <p class="text-xs font-semibold uppercase tracking-wide text-gray-500">Last Modified</p>
    <p class="mt-2 text-2xl font-semibold text-gray-900">{{ view.modified.strftime('%Y-%m-%d') }}</p>
    <p class="text-xs text-gray-500">{{ view.modified.strftime('%H:%M:%S') }}</p>
  </article>
  <article class="rounded-2xl border border-gray-200 bg-white p-5 shadow-sm">
    <p class="text-xs font-semibold uppercase tracking-wide text-gray-500">Actions</p>
    <div class="mt-3 flex flex-wrap gap-3">
      <a href="/context-files/download/{{ view.filepath }}" class="inline-flex items-center gap-2 rounded-lg border border-emerald-200 bg-emerald-50 px-4 py-2 text-sm font-medium text-emerald-700 transition hover:bg-emerald-100">
        <i class="bi bi-download"></i>
        Download
      </a>
      <button id="copyButton" type="button" class="inline-flex items-center gap-2 rounded-lg border border-gray-200 bg-white px-4 py-2 text-sm font-medium text-gray-600 transition hover:border-primary/30 hover:text-primary" onclick="copyToClipboard(event)">
        <i class="bi bi-clipboard"></i>
        Copy Contents
      </button>
    </div>
  </article>
</section>

<section class="mt-8 overflow-hidden rounded-2xl border border-gray-200 bg-white shadow-sm">
  <header class="flex items-center justify-between border-b border-gray-100 px-6 py-4 text-sm font-semibold uppercase tracking-wide text-gray-500">
    <span><i class="bi bi-eye text-primary"></i> File Content</span>
    {% if view.is_truncated %}
    <span class="inline-flex items-center gap-2 rounded-full bg-amber-100 px-3 py-1 text-xs font-semibold text-amber-700">
      <i class="bi bi-exclamation-triangle"></i>
      Preview Limited
    </span>
    {% endif %}
  </header>
  <pre id="fileContent" class="max-h-[600px] overflow-y-auto bg-gray-950 p-6 font-mono text-sm leading-relaxed text-emerald-200">{{ view.content }}</pre>
  {% if view.is_truncated %}
  <footer class="flex flex-col items-center gap-2 border-t border-gray-100 bg-amber-50 px-6 py-4 text-sm text-amber-800 sm:flex-row sm:justify-between">
    <div class="flex items-center gap-2">
      <i class="bi bi-info-circle"></i>
      Preview truncated for large or binary files.
    </div>
    <a href="/context-files/download/{{ view.filepath }}" class="inline-flex items-center gap-2 rounded-lg border border-amber-300 bg-white px-4 py-2 text-xs font-medium text-amber-700 transition hover:bg-amber-100">
      <i class="bi bi-download"></i>
      Download full file
    </a>
  </footer>
  {% endif %}
</section>
{% endblock %}

{% block extra_scripts %}
<script>
function copyToClipboard(event) {
  const btn = event.currentTarget;
  const content = document.getElementById('fileContent').textContent;
  navigator.clipboard.writeText(content).then(() => {
    const original = btn.innerHTML;
    btn.innerHTML = '<i class="bi bi-check"></i> Copied!';
    btn.classList.add('border-emerald-200', 'bg-emerald-50', 'text-emerald-700');
    btn.classList.remove('border-gray-200', 'bg-white', 'text-gray-600');
    setTimeout(() => {
      btn.innerHTML = original;
      btn.classList.remove('border-emerald-200', 'bg-emerald-50', 'text-emerald-700');
      btn.classList.add('border-gray-200', 'bg-white', 'text-gray-600');
    }, 2000);
  }).catch(() => {
    btn.innerHTML = '<i class="bi bi-x-circle"></i> Copy failed';
    btn.classList.add('border-rose-200', 'bg-rose-50', 'text-rose-700');
    setTimeout(() => window.location.reload(), 1500);
  });
}
</script>
{% endblock %}
