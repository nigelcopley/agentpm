{% extends "layouts/modern_base.html" %}

{% block title %}Sessions Timeline{% endblock %}

{% block content %}
<section class="mb-8 flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
  <div>
    <p class="text-xs font-semibold uppercase tracking-wide text-primary">Sessions Timeline</p>
    <h1 class="text-3xl font-bold text-gray-900">Operational Activity</h1>
    <p class="mt-2 max-w-2xl text-sm text-gray-500">
      Aggregated session activity, providers, and work item touch points over the last 30 days.
    </p>
  </div>
  <div class="inline-flex items-center gap-3 rounded-full bg-primary/10 px-4 py-2 text-sm font-semibold text-primary">
    {{ view.total_sessions }} sessions
  </div>
</section>

<section class="grid gap-5 md:grid-cols-2 xl:grid-cols-4">
  <article class="card">
    <p class="text-xs font-semibold uppercase tracking-wide text-gray-500">Active Days</p>
    <p class="mt-2 text-3xl font-bold text-gray-900">{{ view.daily_activity|length }}</p>
    <p class="mt-1 text-xs text-gray-500">Days containing at least one session.</p>
  </article>
  <article class="card">
    <p class="text-xs font-semibold uppercase tracking-wide text-gray-500">Peak Activity</p>
    <p class="mt-2 text-3xl font-bold text-gray-900">
      {% if view.daily_activity %}
        {{ view.daily_activity.values()|max }}
      {% else %}
        0
      {% endif %}
    </p>
    <p class="mt-1 text-xs text-gray-500">Highest sessions recorded in a single day.</p>
  </article>
  <article class="card">
    <p class="text-xs font-semibold uppercase tracking-wide text-gray-500">Providers</p>
    <p class="mt-2 text-3xl font-bold text-gray-900">{{ view.provider_activity|length }}</p>
    <p class="mt-1 text-xs text-gray-500">Unique tools driving session activity.</p>
  </article>
  <article class="card">
    <p class="text-xs font-semibold uppercase tracking-wide text-gray-500">Work Item Touches</p>
    <p class="mt-2 text-3xl font-bold text-gray-900">
      {% if view.work_items_progress %}
        {{ view.work_items_progress.values()|sum }}
      {% else %}
        0
      {% endif %}
    </p>
    <p class="mt-1 text-xs text-gray-500">Total work item references across sessions.</p>
  </article>
</section>

<section class="mt-10 grid gap-6 lg:grid-cols-[2fr_1fr]">
  <article class="card">
    <header class="flex items-center justify-between">
      <div>
        <p class="text-xs font-semibold uppercase tracking-wide text-gray-500">Daily Activity</p>
        <h2 class="text-xl font-semibold text-gray-900">Session Feed</h2>
      </div>
      <span class="rounded-full bg-primary/10 px-3 py-1 text-xs font-semibold text-primary">
        {{ view.sessions_by_date|length }} days
      </span>
    </header>

    {% if view.sessions_by_date %}
    <div class="mt-6 space-y-5">
      {% for date, sessions in view.sessions_by_date|dictsort(reverse=True) %}
      <div class="rounded-xl border border-gray-200 bg-white p-4 shadow-sm">
        <header class="flex items-center justify-between">
          <h3 class="text-sm font-semibold text-gray-800">{{ date }}</h3>
          <span class="rounded-full bg-gray-100 px-3 py-1 text-xs font-semibold text-gray-600">
            {{ sessions|length }} sessions
          </span>
        </header>
        <div class="mt-3 space-y-3 text-sm text-gray-600">
          {% for session in sessions %}
          <div class="rounded-lg border border-gray-200 px-3 py-2">
            <div class="flex items-center justify-between">
              <span class="font-medium text-gray-800">{{ session.tool_name }}</span>
              <span class="text-xs text-gray-500">
                {% if session.duration_minutes %}{{ session.duration_minutes }} min{% else %}Duration N/A{% endif %}
              </span>
            </div>
            <div class="mt-1 flex flex-wrap gap-3 text-xs text-gray-500">
              <span>Session ID: {{ session.session_id[:8] }}â€¦</span>
              {% if session.project_name %}
              <span>Project: {{ session.project_name }}</span>
              {% endif %}
              <span>Tasks Completed: {{ session.tasks_completed }}</span>
              <span>Decisions: {{ session.decisions_made }}</span>
              <span>Commits: {{ session.git_commits }}</span>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <p class="mt-6 rounded-xl border border-dashed border-gray-300 bg-gray-50 p-6 text-sm text-gray-500">
      No session activity recorded in the selected window.
    </p>
    {% endif %}
  </article>

  <article class="card">
    <header>
      <p class="text-xs font-semibold uppercase tracking-wide text-gray-500">Provider Breakdown</p>
      <h2 class="text-xl font-semibold text-gray-900">Tool Utilization</h2>
    </header>
    {% if view.provider_activity %}
    <ul class="mt-6 space-y-3 text-sm text-gray-600">
      {% for provider, count in view.provider_activity|dictsort(by='value', reverse=true) %}
      <li class="flex items-center justify-between rounded-lg border border-gray-200 px-3 py-2">
        <span class="font-medium text-gray-700">{{ provider.title() }}</span>
        <span class="text-xs text-gray-500">{{ count }} sessions</span>
      </li>
      {% endfor %}
    </ul>
    {% else %}
    <p class="mt-6 rounded-xl border border-dashed border-gray-300 bg-gray-50 p-6 text-sm text-gray-500">
      Provider analytics unavailable.
    </p>
    {% endif %}
  </article>
</section>

<section class="mt-10 card">
  <header>
    <p class="text-xs font-semibold uppercase tracking-wide text-gray-500">Work Item Progress</p>
    <h2 class="text-xl font-semibold text-gray-900">Interactions Over Time</h2>
  </header>
  {% if view.work_items_progress %}
  <div class="mt-6 space-y-3 text-sm text-gray-600">
    {% for date, touches in view.work_items_progress|dictsort %}
    <div class="flex items-center justify-between rounded-lg border border-gray-200 px-3 py-2">
      <span class="font-medium text-gray-700">{{ date }}</span>
      <span class="text-xs text-gray-500">{{ touches }} touch points</span>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <p class="mt-6 rounded-xl border border-dashed border-gray-300 bg-gray-50 p-6 text-sm text-gray-500">
    No work item references detected in recent sessions.
  </p>
  {% endif %}
</section>
{% endblock %}
