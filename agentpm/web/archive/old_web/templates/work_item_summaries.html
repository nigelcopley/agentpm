{% extends "layouts/modern_base.html" %}

{% block title %}Session History - {{ view.work_item.name }} - APM (Agent Project Manager){% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="/work-items">Work Items</a></li>
        <li class="breadcrumb-item"><a href="/work-items/{{ view.work_item.id }}">{{ view.work_item.name }}</a></li>
        <li class="breadcrumb-item active" aria-current="page">Session History</li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<div id="work-item-detail">
{% if fallback_used %}
<div class="alert alert-warning d-flex align-items-center mb-4" role="alert">
    <i class="bi bi-exclamation-triangle-fill me-2"></i>
    Requested work item <strong>#{{ requested_work_item_id }}</strong> not found. Showing data for work item <strong>#{{ view.work_item.id }}</strong> instead.
</div>
{% endif %}
<!-- Work Item Header -->
<div class="row mb-4">
    <div class="col">
        <div class="card metric-card">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <h2 class="card-title">
                            <i class="bi bi-clock-history"></i> Session History
                        </h2>
                        <p class="card-text">
                            <strong>Work Item:</strong> {{ view.work_item.name }}
                        </p>
                        <p class="text-muted">{{ view.work_item.description or 'No description' }}</p>
                    </div>
                    <div class="col-md-4 text-end">
                        <a href="/work-items/{{ view.work_item.id }}" class="btn btn-outline-primary">
                            <i class="bi bi-arrow-left"></i> Back to Work Item
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Summary Statistics -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card metric-card">
            <div class="card-body text-center">
                <h3 class="display-6">{{ view.total_sessions }}</h3>
                <p class="text-muted">Total Sessions</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card metric-card">
            <div class="card-body text-center">
                <h3 class="display-6">{{ view.total_hours }}h</h3>
                <p class="text-muted">Total Hours</p>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card metric-card">
            <div class="card-body">
                <h5 class="card-title">Session Types</h5>
                <div class="d-flex justify-content-around">
                    {% for stype, count in view.session_types.items() %}
                    <div class="text-center">
                        <span class="badge badge-gray">{{ stype }}</span>
                        <p class="mb-0 mt-1"><strong>{{ count }}</strong></p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Session Timeline -->
<div class="row mb-4">
    <div class="col">
        <div class="card metric-card">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="bi bi-list-ul"></i> Session Timeline
                    <span class="text-muted small">({{ view.summaries|length }} entries)</span>
                </h5>

                {% if view.summaries %}
                <div class="timeline">
                    {% for summary in view.summaries %}
                    <div class="timeline-item type-{{ summary.summary_type or 'session' }}">
                        <!-- Timeline Marker -->
                        <div class="timeline-marker {% if summary.summary_type == 'milestone' %}milestone{% elif summary.summary_type == 'decision' %}decision{% endif %}"></div>

                        <!-- Timeline Content -->
                        <div class="timeline-content">
                            <!-- Header -->
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div>
                                    <div class="timeline-date">
                                        <i class="bi bi-calendar-event"></i> {{ summary.session_date }}
                                        {% if summary.session_duration_hours %}
                                            <span class="text-muted small">
                                                ({{ summary.session_duration_hours }}h)
                                            </span>
                                        {% endif %}
                                    </div>
                                </div>
                                <div>
                                    {% if summary.summary_type == 'milestone' %}
                                        <span class="badge badge-warning text-dark">
                                            <i class="bi bi-trophy"></i> Milestone
                                        </span>
                                    {% elif summary.summary_type == 'decision' %}
                                        <span class="badge badge-error">
                                            <i class="bi bi-exclamation-triangle"></i> Decision
                                        </span>
                                    {% elif summary.summary_type == 'checkpoint' %}
                                        <span class="badge badge-success">
                                            <i class="bi bi-flag"></i> Checkpoint
                                        </span>
                                    {% else %}
                                        <span class="badge badge-primary">
                                            <i class="bi bi-clock"></i> Session
                                        </span>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Summary Text -->
                            <div class="summary-text mb-3">
                                {{ summary.summary_text }}
                            </div>

                            <!-- Metadata -->
                            {% if summary.context_metadata %}
                            <div class="mt-3 pt-3 border-top">
                                <h6 class="text-muted mb-2">
                                    <i class="bi bi-info-circle"></i> Metadata
                                </h6>
                                <div class="metadata-display">
                                    {% if summary.context_metadata.get('key_decisions') %}
                                    <div class="mb-2">
                                        <strong>Key Decisions:</strong>
                                        <ul class="mb-0">
                                            {% for decision in summary.context_metadata.key_decisions %}
                                            <li>{{ decision }}</li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                    {% endif %}

                                    {% if summary.context_metadata.get('tasks_completed') %}
                                    <div class="mb-2">
                                        <strong>Tasks Completed:</strong>
                                        {% set tasks = summary.context_metadata.tasks_completed %}
                                        {% if tasks is number %}
                                            <span class="badge badge-success">{{ tasks }} tasks</span>
                                        {% elif tasks is iterable and tasks is not string %}
                                            {% for task_id in tasks %}
                                            <a href="/tasks/{{ task_id }}" class="badge badge-success text-decoration-none">
                                                Task #{{ task_id }}
                                            </a>
                                            {% endfor %}
                                        {% else %}
                                            <span class="badge badge-success">{{ tasks }}</span>
                                        {% endif %}
                                    </div>
                                    {% endif %}

                                    {% if summary.context_metadata.get('blockers_resolved') %}
                                    <div class="mb-2">
                                        <strong>Blockers Resolved:</strong>
                                        <ul class="mb-0">
                                            {% for blocker in summary.context_metadata.blockers_resolved %}
                                            <li>{{ blocker }}</li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                    {% endif %}

                                    {% if summary.context_metadata.get('next_steps') %}
                                    <div class="mb-2">
                                        <strong>Next Steps:</strong>
                                        <ul class="mb-0">
                                            {% for step in summary.context_metadata.next_steps %}
                                            <li>{{ step }}</li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}

                            <!-- Attribution -->
                            <div class="text-muted small mt-3">
                                {% if summary.created_by %}
                                <i class="bi bi-person"></i> {{ summary.created_by }}
                                {% endif %}
                                {% if summary.created_at %}
                                <i class="bi bi-clock"></i> {{ summary.created_at.strftime('%Y-%m-%d %H:%M') }}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="alert alert-info" role="alert">
                    <i class="bi bi-info-circle"></i> No session summaries have been recorded for this work item yet.
                    <p class="mb-0 mt-2">
                        <small>Use <code>apm work-item add-summary {{ view.work_item.id }} --text "Summary text"</code> to add session summaries.</small>
                    </p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Legend -->
<div class="row mb-4">
    <div class="col">
        <div class="card metric-card">
            <div class="card-body">
                <h5 class="card-title">Timeline Legend</h5>
                <div class="row">
                    <div class="col-md-6">
                        <ul class="list-unstyled">
                            <li class="mb-2">
                                <span class="badge badge-primary"><i class="bi bi-clock"></i> Session</span>
                                - Regular work session summary
                            </li>
                            <li class="mb-2">
                                <span class="badge badge-warning text-dark"><i class="bi bi-trophy"></i> Milestone</span>
                                - Significant achievement or completion
                            </li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <ul class="list-unstyled">
                            <li class="mb-2">
                                <span class="badge badge-error"><i class="bi bi-exclamation-triangle"></i> Decision</span>
                                - Important architectural or strategic decision
                            </li>
                            <li class="mb-2">
                                <span class="badge badge-success"><i class="bi bi-flag"></i> Checkpoint</span>
                                - Progress checkpoint or status update
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>
{% endblock %}
