{# Import Component Macros (WI-141 Phase 1) #}
{% from 'macros/breadcrumb.html' import breadcrumb, breadcrumb_compact, breadcrumb_with_icons %}
{% from 'macros/skeleton.html' import skeleton_card, skeleton_table, skeleton_list, skeleton_text, skeleton_metric, skeleton_form %}
{% from 'macros/quick_actions.html' import quick_actions, quick_actions_icon, quick_actions_button_group %}
{% from 'macros/alerts.html' import alert %}

<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}AgentPM - Agent Project Manager Dashboard{% endblock %}</title>

    <!-- Favicon -->
    {% from 'macros/logo.html' import favicon_links %}
    {{ favicon_links() }}

    <!-- Brand System CSS -->
    <!-- Theme System CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/theme-system.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/loading-states.css') }}">
    
    <!-- Enhanced Markdown Styling -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/markdown-enhancements.css') }}">

    <!-- Iconography (Bootstrap Icons) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <!-- Inter Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Additional CSS -->
    {% block extra_css %}{% endblock %}
    
    <!-- Meta Tags -->
    <meta name="description" content="{% block description %}AgentPM - Agent Project Manager V2 - Professional project management dashboard{% endblock %}">
    <meta name="author" content="AgentPM - Agent Project Manager">

    <!-- Alpine.js for lightweight interactivity -->
    <script defer src="{{ url_for('static', filename='js/sidebar-controller.js') }}"></script>
    
    <!-- Enhanced Markdown JavaScript -->
    <script src="{{ url_for('static', filename='js/markdown-enhancements.js') }}"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.1/dist/cdn.min.js"></script>
</head>

<body class="h-full min-h-screen bg-gray-50 text-gray-900"
      x-data="{ globalLoading: false }"
      @htmx:before-request.window="globalLoading = true"
      @htmx:after-request.window="globalLoading = false"
      @htmx:after-settle.window="globalLoading = false">
{% set show_sidebar = show_sidebar if show_sidebar is defined else False %}
{% if show_sidebar == 'work-items' %}
    {% set sidebar_template = 'components/layout/sidebar_work_items.html' %}
{% elif show_sidebar == 'tasks' %}
    {% set sidebar_template = 'components/layout/sidebar_tasks.html' %}
{% elif show_sidebar == 'ideas' %}
    {% set sidebar_template = 'components/layout/sidebar_ideas.html' %}
{% elif show_sidebar == 'documents' %}
    {% set sidebar_template = 'components/layout/sidebar_documents.html' %}
{% else %}
    {% set sidebar_template = 'components/layout/sidebar.html' if show_sidebar else None %}
{% endif %}
{% set metrics = metrics if metrics is defined else namespace(
    total_work_items=0,
    in_progress_tasks=0,
    completed_tasks=0,
    blocked_tasks=0,
    draft_work_items=0,
    ready_work_items=0,
    active_work_items=0,
    review_work_items=0,
    done_work_items=0,
    blocked_work_items=0,
    archived_work_items=0,
    cancelled_work_items=0,
    feature_work_items=0,
    enhancement_work_items=0,
    bugfix_work_items=0,
    research_work_items=0,
    analysis_work_items=0,
    documentation_work_items=0,
    maintenance_work_items=0,
    priority_1_work_items=0,
    priority_2_work_items=0,
    priority_3_work_items=0,
    phase_d1_discovery=0,
    phase_p1_plan=0,
    phase_i1_implementation=0,
    phase_r1_review=0,
    phase_o1_operations=0,
    phase_e1_evolution=0
) %}
    <!-- Header -->
    {% include 'components/layout/header.html' %}
    
    <!-- Main Layout -->
    <div class="flex min-h-[calc(100vh-4rem)]">
        <!-- Sidebar -->
        {% if sidebar_template %}
        <div class="hidden lg:block">
            {% include sidebar_template %}
        </div>
        {% endif %}
        
        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <!-- Breadcrumbs (using macro from WI-141) -->
                {% if breadcrumbs %}
                {{ breadcrumb(breadcrumbs) }}
                {% endif %}
                
                <!-- Page Header -->
                {% if page_title %}
                <div class="mb-8">
                    <div class="flex items-center justify-between">
                        <div>
                            <h1 class="text-3xl font-bold text-gray-900">{{ page_title }}</h1>
                            {% if page_subtitle %}
                            <p class="mt-2 text-lg text-gray-600">{{ page_subtitle }}</p>
                            {% endif %}
                        </div>
                        {% if page_actions %}
                        <div class="flex items-center space-x-3">
                            {{ page_actions|safe }}
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                
                <!-- Flash Messages -->
                {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                    {{ alert(category, message, dismissible=True) }}
                    {% endfor %}
                {% endif %}
                {% endwith %}
                
                <!-- Page Content -->
                {% block content %}{% endblock %}
            </div>
        </main>
    </div>
    
    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>
    
    <!-- Global Loading Overlay (Alpine.js controlled) -->
    <div x-show="globalLoading"
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center"
         style="display: none;">
        <div class="bg-white rounded-lg shadow-xl p-6 flex items-center space-x-3">
            <div class="animate-spin rounded-full h-8 w-8 border-4 border-primary border-t-transparent"></div>
            <span class="text-gray-700 font-medium">Loading...</span>
        </div>
    </div>
    
    <!-- JavaScript -->
    <script src="{{ url_for('static', filename='js/brand-system.js') }}"></script>
    <script src="{{ url_for('static', filename='js/loading-states.js') }}"></script>

    <!-- WebSocket Client for Real-Time Updates (WI-125) -->
    {% include 'components/websocket_client.html' %}

    {% block extra_js %}{% endblock %}

    <!-- Global JavaScript -->
    <script>
        // Global utility functions
        function showLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
        }
        
        function hideLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }
        
        function showToast(message, type = 'info', duration = 5000) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            const typeClasses = {
                'success': 'alert-success',
                'error': 'alert-error',
                'warning': 'alert-warning',
                'info': 'alert-info'
            };
            
            toast.className = `alert ${typeClasses[type]} transform transition-all duration-300 translate-x-full`;
            toast.innerHTML = `
                <div class="flex items-center justify-between">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-current opacity-70 hover:opacity-100">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                    </button>
                </div>
            `;
            
            container.appendChild(toast);
            
            // Animate in
            setTimeout(() => {
                toast.classList.remove('translate-x-full');
            }, 100);
            
            // Auto remove
            if (duration > 0) {
                setTimeout(() => {
                    toast.classList.add('translate-x-full');
                    setTimeout(() => {
                        if (toast.parentElement) {
                            toast.remove();
                        }
                    }, 300);
                }, duration);
            }
        }
        
        // Global error handler
        window.addEventListener('error', function(e) {
            console.error('Global error:', e.error);
            showToast('An unexpected error occurred', 'error');
        });
        
        // Global AJAX error handler
        document.addEventListener('DOMContentLoaded', function() {
            // Override fetch to handle errors globally
            const originalFetch = window.fetch;
            window.fetch = function(...args) {
                return originalFetch.apply(this, args)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        return response;
                    })
                    .catch(error => {
                        console.error('Fetch error:', error);
                        showToast('Network error occurred', 'error');
                        throw error;
                    });
            };
        });
    </script>
</body>
</html>
